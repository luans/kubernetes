{{- range $svc := .Values.services }}
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ $svc.name }}-policy
  namespace: {{ $svc.namespace | default $.Release.Namespace }}
spec:
  selector:
    matchLabels:
      {{- toYaml $svc.selector | nindent 6 }}
  action: ALLOW
  rules:
  {{- range $svc.policies }}
    - 
      to:
        - operation:
            paths:
            {{- range .paths }}
              - {{ . | quote }}
            {{- end }}
            methods:
            {{- range .methods }}
              - {{ . | quote }}
            {{- end }}
      {{- if and (not .public) (not (empty .allowedRoles)) }}
      when:
      - key: {{ $.Values.jwtRuleKey | default "request.auth.claims[roles]" }}
        values:
        {{- range .allowedRoles }}
          - {{ . | quote }}
        {{- end }}
      {{- end }}
  {{- end }}
{{- end }}